- name: Create and start watchtower container
  community.docker.docker_compose_v2:
    project_src: "{{ watchtower_app_dir }}"
    state: present
    recreate: always
  register: output
  listen: "Restart Watchtower"
  when: not ansible_check_mode

- name: Check that all containers are running
  ansible.builtin.assert:
    that:
      - watchtower.State == 'running'
  vars:
    watchtower: >-
      {{ output.containers | selectattr("Service", "equalto", "watchtower") | first }}
  listen: "Restart Watchtower"
  when: not ansible_check_mode
